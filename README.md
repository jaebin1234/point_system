
# pont_system : 포인트 관리 시스템

1. 포인트 충전/차감 시스템에서 발생할 수 있는 동시성 문제를 해결
2. 포인트 정산을 위한 대규모 데이터 처리를 효율적으로 수행
3. 해당 프로젝트는 **Spring Boot**, **Apache Kafka**, **Spring WebFlux**, **Spring Batch**를 활용하여 신뢰성 높은 포인트 트랜잭션 관리 시스템을 구현

---

## 🗂️ 프로젝트 구조 및 계획

### **진행 단계**
- [ ] **프로젝트 셋업**: Spring Boot 내장 톰캣으로 서버 구성
- [ ] **API 공통 응답**: 표준 응답 형식 정의
- [ ] **프로퍼티 설정**: DB 및 환경 설정 추가, 암호화 적용
- [ ] **CustomException 추가**
- [ ] **DTO 및 VO 생성**: RequestDTO, ResponseDTO, VO 클래스 생성
- [ ] **회사 관리 API**:
  - [ ] 회사 생성 API
  - [ ] 회사 조회 API
  - [ ] 랜덤 10개 회사 생성 테스트 코드
  - [ ] 포인트 지갑 추가, 회사 생성 시 지갑 자동 생성
- [ ] **유저 관리 API**:
  - [ ] 유저 생성 API
  - [ ] 유저 조회 API
  - [ ] 랜덤 유저 생성 테스트 코드
- [ ] **API 유효성 검사**: 요청값 Validation 추가
- [ ] **포인트 충전 API**:
  - [ ] 유상/무상 포인트 충전 로직
  - [ ] 여러 회사의 랜덤 유상/무상 포인트 충전 테스트 코드
- [ ] **포인트 차감 API**:
  - [ ] 무상 포인트 → 유상 포인트 순으로 차감
  - [ ] 다양한 차감 테스트 코드 (무상/유상/무상+유상)
  - [ ] 동시성 테스트: 서로 다른 스레드에서 포인트 차감 및 업데이트
- [ ] **Kafka 서버 구축**: 메시지 브로커 설정
- [ ] **Spring WebFlux 서버 구축**:
  - Kafka 메시지를 비동기로 패칭하여 포인트 재차감 처리
- [ ] **포인트 정산**:
  - 단일 회사 정산 API(정산 회사 조회, 정산 계산 처리, 계산된 데이터 업데이트)
  - Spring Batch를 이용한 대규모 병렬 정산

---

## 🚀 기술 스택

| 기술             | 버전      |
|-------------------|-----------|
| **Java**          | 17        |
| **Spring Boot**   | 3.1.4     |
| **PostgreSQL**    | LTS       |
| **MyBatis**       | 3.0.3     |
| **JUnit**         | 5         |
| **Spring Batch**  | LTS       |

---

## 🏗️ 시스템 아키텍처

### **개요**
이 시스템은 포인트 트랜잭션 처리 시 발생할 수 있는 **동시성 문제를 낙관적 락(Optimistic Lock)**으로 해결하고, **Kafka 기반 비동기 처리**를 통해 실패한 트랜잭션을 재처리합니다. 또한, Spring Batch를 활용한 병렬 정산으로 대규모 데이터를 효율적으로 처리합니다.

### **구성 요소**
1. **Spring MVC 포인트 서버 (8080)**:
   - 포인트 생성/차감 API 제공
   - 낙관적 락 적용 및 실패 시 Kafka로 메시지 전송
2. **Spring WebFlux 비동기 서버 (8081)**:
   - Kafka 메시지를 소비하여 포인트 차감 요청 비동기 재처리
3. **Apache Kafka**:
   - 실패 메시지를 처리하는 중앙 메시지 브로커
4. **PostgreSQL**:
   - 포인트 및 트랜잭션 데이터 저장소
5. **Spring Batch**:
   - 대규모 병렬 정산 처리

### **아키텍처 다이어그램**

---

## 🔍 구현 및 테스트 과정

1. **랜덤 데이터 생성**
   - 10개의 랜덤 회사 생성
   - 회사당 3명의 유저 생성 (총 30명)
2. **포인트 충전**
   - 회사별 무작위 포인트 충전(무상/유상 포인트)
3. **포인트 차감**
   - 특정 유저가 회사 포인트 차감
   - 동시성 문제를 테스트하기 위해 두 스레드에서 차감 요청:
     - 스레드 1: 포인트 조회 후 2초 대기 후 차감
     - 스레드 2: 동일한 회사의 포인트 조회 후 스레드 1보다 먼저 포인트 차감
4. **동시성 문제 해결**
   - 낙관적 락 적용 (업데이트 실패 시 예외 발생)
   - 실패 시 Kafka에 메시지 송신
   - WebFlux 서버가 Kafka 메시지를 소비하여 재시도
5. **포인트 정산**
   - 단일 회사 정산 API 개발
   - Spring Batch로 병렬 처리 기반 대규모 정산 구현

---

## 📈 목표 및 기대 효과

### **목표**
- 데이터 정합성 확보: 포인트 트랜잭션 중 동시성 문제 해결
- 확장 가능한 시스템 설계: 대규모 데이터 병렬 처리
- 장애 복구: Kafka 기반 비동기 메시지 재처리

### **기대 효과**
- 안정적이고 신뢰성 있는 포인트 관리 시스템
- 대규모 데이터 처리 및 운영 비용 절감
- 빠르고 효율적인 오류 복구
